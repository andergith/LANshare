<!DOCTYPE html>
<html lang="es-ES">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LANshare - MQTT Protocol</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- MQTT.js: Librer铆a robusta para se帽alizaci贸n -->
    <script src="https://unpkg.com/mqtt@5.3.5/dist/mqtt.min.js"></script>
    <!-- Iconos Phosphor -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .animate-pulse-slow {
            animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        .fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-indigo-950 to-slate-900 min-h-screen text-slate-100 flex items-center justify-center p-4">

    <div class="w-full max-w-lg bg-slate-800/90 border border-slate-700/50 rounded-2xl shadow-2xl overflow-hidden relative min-h-[600px] flex flex-col backdrop-blur-sm">
        
        <!-- Header -->
        <div class="p-6 border-b border-slate-700/50 flex justify-between items-center bg-slate-800/50 sticky top-0 z-20">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-500/20 p-2 rounded-lg">
                    <i class="ph-fill ph-paper-plane-tilt text-indigo-400 text-xl"></i>
                </div>
                <h1 class="text-xl font-bold tracking-tight text-white">LANshare <span class="text-[10px] bg-indigo-600 px-1 rounded text-white opacity-70">MQTT v4.2</span></h1>
            </div>
            <div id="connection-status" class="hidden text-[10px] font-mono bg-emerald-500/10 text-emerald-400 px-3 py-1.5 rounded-full flex items-center gap-2 border border-emerald-500/20">
                <div class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></div>
                P2P ACTIVO
            </div>
        </div>

        <!-- VISTAS DE LA APP -->
        <main class="flex-1 relative p-6 overflow-hidden">
            
            <!-- 0. Pantalla de Carga (Overlay) -->
            <div id="view-loading" class="hidden flex-col items-center justify-center h-full text-center gap-6 fade-in z-50 absolute inset-0 bg-slate-900/95 backdrop-blur-sm">
                <div class="relative">
                    <div class="w-16 h-16 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <i class="ph-fill ph-broadcast text-indigo-500 animate-pulse"></i>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-bold text-white mb-1" id="loading-title">Conectando...</h3>
                    <p class="text-slate-400 text-xs font-mono" id="loading-status">Inicializando Broker MQTT</p>
                </div>
                <button onclick="location.reload()" class="mt-8 text-xs text-slate-500 hover:text-white underline">Cancelar</button>
            </div>

            <!-- 1. Inicio -->
            <div id="view-home" class="flex flex-col gap-4 h-full justify-center fade-in">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-white">Modo Robusto</h2>
                    <p class="text-slate-400 text-sm mt-2">Sistema de alta fiabilidad v铆a MQTT + WebRTC.</p>
                </div>
                
                <button onclick="app.setRole('sender')" class="group relative p-5 rounded-xl bg-slate-700/30 hover:bg-indigo-600/20 border border-slate-600 hover:border-indigo-500 transition-all duration-300 text-left hover:shadow-lg hover:shadow-indigo-500/10">
                    <div class="absolute top-5 right-5 bg-indigo-500/20 p-2 rounded-lg group-hover:bg-indigo-500 group-hover:text-white transition-colors text-indigo-400">
                        <i class="ph ph-upload-simple text-xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-white mb-1">Enviar Ficheros</h3>
                    <p class="text-slate-400 text-xs leading-relaxed max-w-[80%]">Crear canal seguro y esperar conexi贸n.</p>
                </button>

                <button onclick="app.setRole('receiver')" class="group relative p-5 rounded-xl bg-slate-700/30 hover:bg-emerald-600/20 border border-slate-600 hover:border-emerald-500 transition-all duration-300 text-left hover:shadow-lg hover:shadow-emerald-500/10">
                    <div class="absolute top-5 right-5 bg-emerald-500/20 p-2 rounded-lg group-hover:bg-emerald-500 group-hover:text-white transition-colors text-emerald-400">
                        <i class="ph ph-download-simple text-xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-white mb-1">Recibir Ficheros</h3>
                    <p class="text-slate-400 text-xs leading-relaxed max-w-[80%]">Introducir c贸digo para enlazar.</p>
                </button>
            </div>

            <!-- 2. Receptor (Formulario de Conexi贸n) -->
            <div id="view-receiver" class="hidden flex-col h-full items-center justify-center text-center gap-8 fade-in">
                 <div class="flex flex-col gap-5 w-full max-w-sm">
                    <div class="text-left">
                        <label class="text-xs text-indigo-300 font-bold uppercase tracking-wider mb-2 block">ID de la Sala</label>
                        <div class="flex gap-2 relative">
                            <input type="text" id="remote-id-input" placeholder="Ej: ROJO-LOBO-99" class="flex-1 bg-slate-900/50 border border-slate-600 rounded-lg px-4 py-3 focus:outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 font-mono uppercase text-white placeholder-slate-600 transition-all text-lg pl-10">
                            <div class="absolute left-3 top-4 text-slate-500">
                                <i class="ph-bold ph-hash"></i>
                            </div>
                        </div>
                    </div>
                    <button onclick="app.connectAsReceiver()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-3.5 rounded-lg font-bold transition-all shadow-lg shadow-emerald-900/20 active:scale-[0.98]">
                        Conectar a Sala
                    </button>
                </div>
                <button onclick="location.reload()" class="text-slate-500 hover:text-white text-xs mt-4 underline decoration-slate-600 underline-offset-4">Volver atr谩s</button>
            </div>

            <!-- 3. Emisor (ID Display + Drop Zone) -->
            <div id="view-sender" class="hidden flex-col h-full gap-4 justify-center fade-in">
                
                <!-- ID Card -->
                <div id="sender-id-wrapper" class="flex flex-col items-center gap-8 w-full">
                    <div class="relative w-full flex flex-col items-center">
                        <div class="absolute inset-0 bg-indigo-500 blur-[60px] opacity-10"></div>
                        <div class="relative bg-slate-900/80 p-8 rounded-2xl border border-slate-600 shadow-2xl w-full max-w-xs text-center backdrop-blur-md">
                            <p class="text-[10px] text-indigo-300 uppercase tracking-widest font-bold mb-4">C贸digo de Sala</p>
                            <div class="flex items-center justify-center gap-3 bg-black/40 p-4 rounded-xl border border-slate-700/50 group cursor-pointer active:scale-95 transition-transform" onclick="app.copyId()">
                                <code id="my-peer-id" class="text-3xl font-mono text-white font-bold tracking-wider select-all">...</code>
                                <i class="ph-bold ph-copy text-slate-500 group-hover:text-white transition-colors"></i>
                            </div>
                            <div class="mt-4 flex items-center justify-center gap-2 text-[10px] text-emerald-400 bg-emerald-500/10 px-2 py-1 rounded border border-emerald-500/20">
                                <div class="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></div>
                                Se帽alizaci贸n MQTT Activa
                            </div>
                        </div>
                    </div>
                    <p class="text-slate-400 text-sm animate-pulse">Esperando al receptor...</p>
                    <button onclick="location.reload()" class="text-slate-500 hover:text-white text-xs underline">Cancelar</button>
                </div>

                <!-- Drop Zone -->
                <div id="drop-zone" class="hidden flex-1 border-2 border-dashed border-slate-600 rounded-xl bg-slate-800/30 hover:bg-slate-800/50 hover:border-indigo-500 transition-all flex-col items-center justify-center p-6 text-center cursor-pointer group relative overflow-hidden">
                    <input type="file" id="file-input" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="app.handleFileSelect(this)">
                    <div class="w-20 h-20 bg-slate-700 rounded-full flex items-center justify-center mb-4 group-hover:scale-110 transition-transform shadow-lg">
                        <i class="ph-fill ph-file-plus text-3xl text-indigo-400"></i>
                    </div>
                    <h3 class="text-xl font-bold text-white group-hover:text-indigo-300 transition-colors">Elige un fichero</h3>
                    
                    <div class="mt-8 bg-emerald-500/10 px-4 py-2 rounded-full border border-emerald-500/20 flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></div>
                        <span class="text-xs text-emerald-400 font-bold uppercase tracking-wide">Enlazado con 茅xito</span>
                    </div>
                </div>
                
                <div id="sender-waiting-approval" class="hidden flex-col items-center justify-center h-full text-center p-6 fade-in">
                    <div class="w-16 h-16 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin mb-6"></div>
                    <h3 class="text-lg font-bold text-white">Esperando confirmaci贸n</h3>
                    <p class="text-slate-400 text-sm mt-2 max-w-xs">El receptor debe aceptar la descarga.</p>
                </div>
            </div>

            <!-- 2b. Aceptaci贸n -->
            <div id="view-accept" class="hidden absolute inset-0 bg-slate-900/95 z-50 flex-col h-full items-center justify-center text-center gap-8 fade-in p-6">
                <div class="w-24 h-24 bg-slate-800 text-indigo-400 rounded-2xl flex items-center justify-center shadow-2xl border border-slate-700">
                    <i class="ph-fill ph-file-arrow-down text-5xl"></i>
                </div>
                <div>
                    <h3 class="text-2xl font-bold text-white mb-2">Fichero Entrante</h3>
                    <p class="text-indigo-300 font-medium text-lg break-all px-4" id="accept-filename">archivo.zip</p>
                    <div class="flex items-center justify-center gap-2 mt-2">
                        <span class="bg-slate-800 text-slate-400 text-xs px-2 py-1 rounded border border-slate-700" id="accept-filesize">0 MB</span>
                    </div>
                </div>
                <div class="flex flex-col gap-3 w-full max-w-xs">
                    <button onclick="app.acceptTransfer()" class="w-full py-4 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-bold transition-all shadow-xl shadow-indigo-900/30">
                        Descargar
                    </button>
                    <button onclick="location.reload()" class="w-full py-3 bg-transparent border border-slate-600 hover:bg-slate-800 text-slate-400 rounded-xl">
                        Rechazar
                    </button>
                </div>
                 <div id="ram-warning" class="hidden bg-yellow-500/10 border border-yellow-500/20 p-3 rounded-lg max-w-xs">
                    <p class="text-[10px] text-yellow-200 text-left">
                        <strong class="block mb-1">锔 Modo Memoria RAM</strong>
                        Sin acceso a disco directo. Archivos >500MB pueden fallar.
                    </p>
                </div>
            </div>

            <!-- 4. Progreso -->
            <div id="view-progress" class="hidden flex-col h-full justify-center gap-8 fade-in">
                <div class="text-center">
                    <h3 id="file-name-display" class="font-bold text-white text-lg truncate px-4">documento.zip</h3>
                    <p id="file-size-display" class="text-xs text-slate-400 mt-1 font-mono bg-slate-800 inline-block px-2 py-1 rounded">0 MB</p>
                </div>

                <div class="space-y-2">
                    <div class="flex justify-between text-xs text-slate-300 font-bold px-1">
                        <span id="percent-display">0%</span>
                        <span id="speed-display" class="font-mono text-indigo-400">0 MB/s</span>
                    </div>
                    <div class="w-full bg-slate-700/50 rounded-full h-3 overflow-hidden relative border border-slate-600">
                        <div id="progress-bar" class="bg-gradient-to-r from-indigo-500 to-cyan-400 h-full w-0 transition-all duration-300 ease-out shadow-[0_0_10px_rgba(99,102,241,0.5)]"></div>
                    </div>
                </div>

                <div class="flex justify-center gap-2">
                    <span id="storage-mode-badge" class="text-[10px] uppercase tracking-wider px-3 py-1.5 rounded-md font-bold transition-all">...</span>
                </div>

                <p id="status-message" class="text-center text-sm text-indigo-300 animate-pulse font-medium">Transfiriendo...</p>

                <button onclick="location.reload()" id="btn-reset" class="hidden w-full py-3.5 bg-slate-700 hover:bg-slate-600 text-white rounded-xl transition-colors font-bold flex items-center justify-center gap-2">
                    Nueva Transferencia
                </button>
            </div>

        </main>

        <!-- Debug Console -->
        <div class="bg-black/80 p-3 h-28 overflow-y-auto no-scrollbar border-t border-slate-700/50 text-[10px] font-mono text-slate-400 select-text">
            <div id="logs" class="flex flex-col gap-1.5">
                <div class="text-slate-500 border-b border-slate-800 pb-1 mb-1">[Sistema] Motor MQTT v4.2 inicializado.</div>
            </div>
        </div>
    </div>

    <script>
        /* --- CONFIGURACIN TCNICA --- */
        const APP_CONFIG = {
            MQTT_BROKER: 'wss://broker.emqx.io:8084/mqtt', 
            CHUNK_SIZE: 64 * 1024,
            MAX_BUFFER: 16 * 1024 * 1024,
            RAM_LIMIT_WARNING: 500 * 1024 * 1024,
            ICE_SERVERS: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                { urls: 'stun:global.stun.twilio.com:3478' }
            ]
        };

        const ADJECTIVES = ['ROJO', 'AZUL', 'VERDE', 'NEGRO', 'BLANCO', 'RAPIDO', 'LISTO', 'FELIZ', 'BRAVO', 'NOBLE'];
        const NOUNS = ['LOBO', 'GATO', 'OSO', 'HALCON', 'ZORRO', 'LEON', 'TIGRE', 'BUHO', 'DRAGON', 'PANDA'];
        
        function generateId() {
            const adj = ADJECTIVES[Math.floor(Math.random() * ADJECTIVES.length)];
            const noun = NOUNS[Math.floor(Math.random() * NOUNS.length)];
            const num = Math.floor(Math.random() * 99) + 1;
            return `${adj}-${noun}-${num}`;
        }

        function formatBytes(bytes) {
            if (!+bytes) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return `${parseFloat((bytes / Math.pow(k, i)).toFixed(2))} ${sizes[i]}`;
        }

        /* --- MOTOR DE APLICACIN --- */
        const app = {
            // MQTT & Signaling
            mqttClient: null,
            roomId: null,
            role: null, 
            
            // WebRTC
            peerConnection: null,
            dataChannel: null,
            iceCandidateQueue: [], // COLA PARA CANDIDATOS ICE
            retryCount: 0,
            
            // File Handling
            file: null,
            fileMeta: null,
            fileChunks: [],
            receivedSize: 0,
            startTime: 0,
            fileHandle: null,
            writableStream: null,
            writeQueue: Promise.resolve(),
            supportsFileSystem: false,

            init: function() {
                this.log("Iniciando sistema...", 'system');
                this.supportsFileSystem = 'showSaveFilePicker' in window;
            },

            setRole: function(role) {
                this.role = role;
                this.hideAllViews();
                
                if (role === 'sender') {
                    this.showLoading('Conectando a Red Global', 'Obteniendo canal seguro...');
                    this.roomId = generateId();
                    this.initMQTT(this.roomId, () => {
                        this.hideAllViews();
                        this.showView('view-sender');
                        document.getElementById('my-peer-id').textContent = this.roomId;
                        this.log(`Sala creada: ${this.roomId}`, 'success');
                        this.mqttSubscribe(`lanshare/${this.roomId}/to-sender`);
                    });
                } else {
                    this.showView('view-receiver');
                    this.checkDiskSupport();
                }
            },

            checkDiskSupport: function() {
                 const msg = document.getElementById('disk-support-msg');
                if (this.supportsFileSystem) {
                    msg.innerHTML = "Escritura en Disco Disponible";
                    msg.className = "text-emerald-400 text-[10px] uppercase font-bold tracking-widest opacity-80";
                } else {
                    msg.innerHTML = "Solo Memoria RAM (Limitado)";
                    msg.className = "text-yellow-400 text-[10px] uppercase font-bold tracking-widest opacity-80";
                }
            },

            connectAsReceiver: function() {
                const inputId = document.getElementById('remote-id-input').value.trim().toUpperCase();
                if (!inputId) return alert("Introduce el c贸digo");
                
                this.roomId = inputId;
                this.showLoading('Buscando Emisor', 'Conectando al canal de se帽alizaci贸n...');
                
                this.initMQTT(this.roomId, () => {
                    this.log("MQTT Conectado. Iniciando WebRTC...", 'info');
                    this.initWebRTC(); 
                    this.mqttPublish(`lanshare/${this.roomId}/to-sender`, { type: 'hello' });
                    this.mqttSubscribe(`lanshare/${this.roomId}/to-receiver`);
                });
            },

            initMQTT: function(topicBase, onConnected) {
                const clientId = 'lan_' + Math.random().toString(16).substr(2, 8);
                
                this.mqttClient = mqtt.connect(APP_CONFIG.MQTT_BROKER, {
                    clientId: clientId,
                    keepalive: 60,
                    clean: true,
                    reconnectPeriod: 1000,
                    connectTimeout: 10000
                });

                this.mqttClient.on('connect', () => {
                    this.log("Broker MQTT conectado.", 'system');
                    if (onConnected) onConnected();
                });

                this.mqttClient.on('message', (topic, message) => {
                    try {
                        const data = JSON.parse(message.toString());
                        this.handleSignalingData(data);
                    } catch (e) {
                        console.error("Error parseando se帽al", e);
                    }
                });

                this.mqttClient.on('error', (err) => {
                    this.log(`Error MQTT: ${err.message}`, 'error');
                    this.hideAllViews();
                    alert("Error conectando al servidor de se帽alizaci贸n. Revisa tu internet.");
                    location.reload();
                });
            },

            mqttSubscribe: function(topic) {
                this.mqttClient.subscribe(topic, (err) => {
                    if(!err) this.log(`Escuchando en: ${topic}`, 'system');
                });
            },

            mqttPublish: function(topic, data) {
                if (this.mqttClient && this.mqttClient.connected) {
                    this.mqttClient.publish(topic, JSON.stringify(data));
                }
            },

            initWebRTC: function() {
                this.log("Inicializando RTCPeerConnection...", 'info');
                this.iceCandidateQueue = []; // Resetear cola
                
                this.peerConnection = new RTCPeerConnection({
                    iceServers: APP_CONFIG.ICE_SERVERS,
                    iceTransportPolicy: 'all',
                    iceCandidatePoolSize: 10
                });

                this.peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        // this.log(`Candidato ICE Generado: ${event.candidate.type}`, 'system');
                        const target = this.role === 'sender' ? 'to-receiver' : 'to-sender';
                        this.mqttPublish(`lanshare/${this.roomId}/${target}`, {
                            type: 'candidate',
                            candidate: event.candidate
                        });
                    } else {
                        // this.log("Fin de recolecci贸n de candidatos locales.", 'system');
                    }
                };

                this.peerConnection.onconnectionstatechange = () => {
                    this.log(`Estado WebRTC: ${this.peerConnection.connectionState}`, 'info');
                    if(this.peerConnection.connectionState === 'connected') {
                        this.onWebRTCConnected();
                    } else if (this.peerConnection.connectionState === 'failed') {
                        this.log("Fallo cr铆tico en WebRTC. Intentando recuperar...", 'error');
                        if (this.retryCount === 0) {
                             this.retryCount++;
                             this.peerConnection.restartIce();
                        }
                    }
                };

                if (this.role === 'sender') {
                    this.dataChannel = this.peerConnection.createDataChannel("file-transfer");
                    this.setupDataChannel();
                } else {
                    this.peerConnection.ondatachannel = (event) => {
                        this.dataChannel = event.channel;
                        this.setupDataChannel();
                    };
                }
            },

            setupDataChannel: function() {
                this.dataChannel.onopen = () => {
                    this.log("隆CANAL P2P ABIERTO!", 'success');
                    this.hideAllViews();
                    this.showConnectedUI();
                };
                this.dataChannel.onmessage = (event) => this.handleP2PData(event.data);
                this.dataChannel.onerror = (error) => this.log(`Error Canal: ${error}`, 'error');
            },

            onWebRTCConnected: function() {
                document.getElementById('connection-status').classList.remove('hidden');
                document.getElementById('connection-status').classList.add('flex');
            },

            // --- LGICA CRTICA DE SEALIZACIN CON COLA ---
            handleSignalingData: async function(data) {
                if (data.type === 'hello' && this.role === 'sender') {
                    this.log("Receptor detectado. Generando candidatos...", 'info');
                    this.initWebRTC(); // 1. Inicializar
                    
                    // 2. Crear oferta pero esperar un poco para que se adjunten candidatos
                    const offer = await this.peerConnection.createOffer();
                    await this.peerConnection.setLocalDescription(offer);
                    
                    // ESTRATEGIA: Esperar 500ms a que se recolecten candidatos locales antes de enviar oferta
                    setTimeout(() => {
                        this.log("Enviando Oferta SDP...", 'info');
                         this.mqttPublish(`lanshare/${this.roomId}/to-receiver`, { type: 'offer', offer: this.peerConnection.localDescription });
                    }, 500);

                } else if (data.type === 'offer' && this.role === 'receiver') {
                    this.log("Oferta recibida. Procesando...", 'info');
                    await this.peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
                    // Procesar cola si hab铆a candidatos esperando ANTES de crear respuesta
                    await this.processIceQueue();
                    
                    const answer = await this.peerConnection.createAnswer();
                    await this.peerConnection.setLocalDescription(answer);
                    this.mqttPublish(`lanshare/${this.roomId}/to-sender`, { type: 'answer', answer: answer });

                } else if (data.type === 'answer' && this.role === 'sender') {
                    this.log("Respuesta recibida. Conectando...", 'info');
                    await this.peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
                    // Procesar cola si hab铆a candidatos esperando
                    await this.processIceQueue();

                } else if (data.type === 'candidate') {
                    // Log para confirmar recepci贸n
                    // this.log("Candidato ICE Recibido v铆a MQTT", 'system');
                    
                    if (this.peerConnection && this.peerConnection.remoteDescription && this.peerConnection.remoteDescription.type) {
                        try {
                            await this.peerConnection.addIceCandidate(data.candidate);
                        } catch (e) {
                            console.error("Error a帽adiendo candidato directo", e);
                        }
                    } else {
                        // this.log("Encolando candidato (SDP pendiente)", 'warn');
                        this.iceCandidateQueue.push(data.candidate);
                    }
                }
            },

            processIceQueue: async function() {
                if(this.iceCandidateQueue.length > 0) {
                    this.log(`Procesando cola ICE (${this.iceCandidateQueue.length})...`, 'info');
                    while(this.iceCandidateQueue.length > 0) {
                        const candidate = this.iceCandidateQueue.shift();
                        try {
                            await this.peerConnection.addIceCandidate(candidate);
                        } catch (e) {
                             console.error("Error procesando cola ICE", e);
                        }
                    }
                }
            },

            sendP2P: function(msg) {
                if (this.dataChannel && this.dataChannel.readyState === 'open') {
                    if (typeof msg === 'object' && !(msg instanceof ArrayBuffer)) {
                        this.dataChannel.send(JSON.stringify(msg));
                    } else {
                        this.dataChannel.send(msg); 
                    }
                }
            },

            handleP2PData: async function(raw) {
                if (raw instanceof ArrayBuffer) {
                    this.processChunk(raw);
                    return;
                }
                
                try {
                    const data = JSON.parse(raw);
                    if (data.type === 'meta') {
                        this.fileMeta = data;
                        this.log(`Fichero entrante: ${data.name}`, 'info');
                        document.getElementById('accept-filename').textContent = data.name;
                        document.getElementById('accept-filesize').textContent = formatBytes(data.size);
                        this.showView('view-accept');
                        if(!this.supportsFileSystem && data.size > APP_CONFIG.RAM_LIMIT_WARNING) {
                            document.getElementById('ram-warning').classList.remove('hidden');
                        }

                    } else if (data.type === 'ack') {
                        this.log("Receptor acept贸. Enviando...", 'success');
                        document.getElementById('sender-waiting-approval').classList.add('hidden');
                        this.showView('view-progress');
                        this.startSending();
                    
                    } else if (data.type === 'end') {
                        this.finishReception();
                    }
                } catch (e) { }
            },

            handleFileSelect: function(input) {
                const file = input.files[0];
                if (!file) return;
                this.file = file;
                this.sendP2P({ type: 'meta', name: file.name, size: file.size, mime: file.type });
                
                document.getElementById('drop-zone').classList.add('hidden');
                document.getElementById('drop-zone').classList.remove('flex');
                document.getElementById('sender-waiting-approval').classList.remove('hidden');
                document.getElementById('sender-waiting-approval').classList.add('flex');
            },

            acceptTransfer: async function() {
                this.receivedSize = 0;
                this.fileChunks = [];
                this.writeQueue = Promise.resolve();

                if (this.supportsFileSystem) {
                    try {
                        this.fileHandle = await window.showSaveFilePicker({ suggestedName: this.fileMeta.name });
                        this.writableStream = await this.fileHandle.createWritable();
                        this.setStorageBadge(true);
                    } catch (err) {
                        this.supportsFileSystem = false;
                        this.setStorageBadge(false);
                    }
                } else { this.setStorageBadge(false); }

                this.showView('view-progress');
                this.updateUIProgress(0, this.fileMeta.size);
                document.getElementById('status-message').textContent = "Recibiendo...";
                this.startTime = Date.now();
                this.sendP2P({ type: 'ack' });
            },

            startSending: function() {
                const file = this.file;
                let offset = 0;
                this.startTime = Date.now();
                const reader = new FileReader();

                const readNextChunk = () => {
                    const slice = file.slice(offset, offset + APP_CONFIG.CHUNK_SIZE);
                    reader.readAsArrayBuffer(slice);
                };

                reader.onload = (e) => {
                    if (this.dataChannel.readyState !== 'open') return;
                    
                    this.dataChannel.send(e.target.result); 
                    offset += e.target.result.byteLength;
                    this.updateUIProgress(offset, file.size);

                    if (this.dataChannel.bufferedAmount > APP_CONFIG.MAX_BUFFER) {
                        setTimeout(readNextChunk, 50);
                    } else if (offset < file.size) {
                        setTimeout(readNextChunk, 0);
                    } else {
                        this.sendP2P({ type: 'end' });
                        this.finishTransfer(true);
                    }
                };
                readNextChunk();
            },

            processChunk: function(buffer) {
                this.receivedSize += buffer.byteLength;
                this.updateUIProgress(this.receivedSize, this.fileMeta.size);

                if (this.supportsFileSystem && this.writableStream) {
                    this.writeQueue = this.writeQueue.then(() => 
                        this.writableStream.write(buffer)
                    ).catch(err => console.error(err));
                } else {
                    this.fileChunks.push(buffer);
                }
            },

            finishReception: async function() {
                if (this.supportsFileSystem && this.writableStream) {
                    await this.writeQueue;
                    await this.writableStream.close();
                } else {
                    const blob = new Blob(this.fileChunks, { type: this.fileMeta.mime });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = this.fileMeta.name;
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(() => URL.revokeObjectURL(url), 5000);
                    this.fileChunks = [];
                }
                this.finishTransfer(false);
            },

            showConnectedUI: function() {
                if(this.role === 'receiver') {
                    this.showLoading('Conectado', 'Esperando fichero del emisor...');
                } else {
                    document.getElementById('sender-id-wrapper').classList.add('hidden');
                    document.getElementById('drop-zone').classList.remove('hidden');
                    document.getElementById('drop-zone').classList.add('flex');
                }
            },

            updateUIProgress: function(current, total) {
                const percent = Math.round((current / total) * 100);
                document.getElementById('percent-display').textContent = percent + '%';
                document.getElementById('progress-bar').style.width = percent + '%';
                
                if(this.file || this.fileMeta) {
                     const name = this.file ? this.file.name : this.fileMeta.name;
                     const totalSize = this.file ? this.file.size : this.fileMeta.size;
                     document.getElementById('file-name-display').textContent = name;
                     const sizeEl = document.getElementById('file-size-display');
                     if(sizeEl.textContent === '0 MB') sizeEl.textContent = formatBytes(totalSize);
                }

                const now = Date.now();
                const duration = (now - this.startTime) / 1000;
                if (duration > 1) {
                    const speed = (current / 1024 / 1024) / duration;
                    document.getElementById('speed-display').textContent = speed.toFixed(1) + ' MB/s';
                }
            },

            finishTransfer: function(isSender) {
                document.getElementById('status-message').textContent = isSender ? "Env铆o completado" : "Recibido correctamente";
                document.getElementById('status-message').className = "text-center text-sm text-emerald-400 font-bold";
                document.getElementById('progress-bar').className = "bg-emerald-500 h-full w-full";
                document.getElementById('btn-reset').classList.remove('hidden');
            },

            showLoading: function(title, text) {
                document.getElementById('view-loading').classList.remove('hidden');
                document.getElementById('view-loading').classList.add('flex');
                document.getElementById('loading-title').textContent = title;
                document.getElementById('loading-status').textContent = text;
            },

            hideAllViews: function() {
                const views = ['view-home', 'view-receiver', 'view-sender', 'view-loading', 'view-progress', 'view-accept'];
                views.forEach(v => {
                    const el = document.getElementById(v);
                    el.classList.add('hidden');
                    el.classList.remove('flex');
                });
            },

            showView: function(id) {
                this.hideAllViews();
                document.getElementById(id).classList.remove('hidden');
                document.getElementById(id).classList.add('flex');
            },

            setStorageBadge: function(isDisk) {
                const badge = document.getElementById('storage-mode-badge');
                if(isDisk) {
                    badge.innerHTML = " DISCO";
                    badge.className = "text-[10px] uppercase font-bold tracking-widest px-3 py-1 bg-emerald-500/20 text-emerald-400 border border-emerald-500/30 rounded";
                } else {
                    badge.innerHTML = " RAM";
                    badge.className = "text-[10px] uppercase font-bold tracking-widest px-3 py-1 bg-yellow-500/20 text-yellow-400 border border-yellow-500/30 rounded";
                }
            },

            log: function(msg, type='info') {
                const logs = document.getElementById('logs');
                const div = document.createElement('div');
                div.className = "mb-1 border-b border-slate-800/50 pb-0.5";
                const time = new Date().toLocaleTimeString();
                let color = "text-slate-400";
                if(type==='error') color="text-red-400 font-bold";
                if(type==='success') color="text-emerald-400";
                if(type==='system') color="text-indigo-400";
                
                div.innerHTML = `<span class="opacity-50 text-[10px]">[${time}]</span> <span class="${color}">${msg}</span>`;
                logs.appendChild(div);
                logs.scrollTop = logs.scrollHeight;
            },

            copyId: function() {
                navigator.clipboard.writeText(this.roomId).then(() => alert("C贸digo copiado"));
            }
        };

        window.addEventListener('dragover', e => e.preventDefault());
        window.addEventListener('drop', e => e.preventDefault());
        
        app.init();
    </script>
</body>
</html>