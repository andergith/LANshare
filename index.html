<!DOCTYPE html>
<html lang="es-ES">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LANshare - MQTT v5.1 (Bulletproof)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- MQTT.js -->
    <script src="https://unpkg.com/mqtt@5.3.5/dist/mqtt.min.js"></script>
    <!-- Iconos Phosphor -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Scrollbar oculta */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-950 via-blue-950 to-slate-900 min-h-screen text-slate-100 flex items-center justify-center p-4">

    <div class="w-full max-w-lg bg-slate-900/90 border border-slate-700/50 rounded-2xl shadow-2xl overflow-hidden relative min-h-[650px] flex flex-col backdrop-blur-md">
        
        <!-- Header -->
        <div class="p-6 border-b border-slate-800 flex justify-between items-center bg-slate-900/50 sticky top-0 z-20">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600/20 p-2 rounded-lg">
                    <i class="ph-fill ph-paper-plane-tilt text-blue-400 text-xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight text-white leading-none">LANshare</h1>
                    <span class="text-[10px] text-slate-400 font-mono">v5.1 &bull; Stable Core</span>
                </div>
            </div>
            <div id="connection-status" class="hidden text-[10px] font-mono bg-emerald-500/10 text-emerald-400 px-3 py-1.5 rounded-full flex items-center gap-2 border border-emerald-500/20 shadow-[0_0_10px_rgba(16,185,129,0.2)]">
                <div class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></div>
                ENLAZADO
            </div>
        </div>

        <!-- VISTAS DE LA APP -->
        <main class="flex-1 relative p-6 overflow-hidden">
            
            <!-- 0. Pantalla de Carga (Overlay) -->
            <div id="view-loading" class="hidden flex-col items-center justify-center h-full text-center gap-6 fade-in z-50 absolute inset-0 bg-slate-900/95 backdrop-blur-sm">
                <div class="relative">
                    <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <i class="ph-fill ph-arrows-left-right text-blue-500 animate-pulse"></i>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-bold text-white mb-1" id="loading-title">Estableciendo T煤nel...</h3>
                    <p class="text-slate-400 text-xs font-mono max-w-[200px] mx-auto" id="loading-status">Negociando ruta ICE</p>
                </div>
                <button onclick="location.reload()" class="mt-8 text-xs text-slate-500 hover:text-white underline">Cancelar operaci贸n</button>
            </div>

            <!-- 1. Inicio -->
            <div id="view-home" class="flex flex-col gap-4 h-full justify-center fade-in">
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-bold text-white">Transferencia Segura</h2>
                    <p class="text-slate-400 text-sm mt-2">Protocolo P2P de alta disponibilidad.</p>
                </div>
                
                <button onclick="app.setRole('sender')" class="group relative p-5 rounded-xl bg-slate-800 hover:bg-blue-900/20 border border-slate-700 hover:border-blue-500 transition-all duration-300 text-left hover:shadow-lg hover:shadow-blue-500/10">
                    <div class="absolute top-5 right-5 bg-blue-500/20 p-2 rounded-lg group-hover:bg-blue-500 group-hover:text-white transition-colors text-blue-400">
                        <i class="ph ph-upload-simple text-xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-white mb-1">Enviar Ficheros</h3>
                    <p class="text-slate-400 text-xs leading-relaxed max-w-[80%]">Crea una sala y espera la conexi贸n del receptor.</p>
                </button>

                <button onclick="app.setRole('receiver')" class="group relative p-5 rounded-xl bg-slate-800 hover:bg-emerald-900/20 border border-slate-700 hover:border-emerald-500 transition-all duration-300 text-left hover:shadow-lg hover:shadow-emerald-500/10">
                    <div class="absolute top-5 right-5 bg-emerald-500/20 p-2 rounded-lg group-hover:bg-emerald-500 group-hover:text-white transition-colors text-emerald-400">
                        <i class="ph ph-download-simple text-xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-white mb-1">Recibir Ficheros</h3>
                    <p class="text-slate-400 text-xs leading-relaxed max-w-[80%]">Introduce el c贸digo para descargar.</p>
                </button>
            </div>

            <!-- 2. Receptor (Formulario) -->
            <div id="view-receiver" class="hidden flex-col h-full items-center justify-center text-center gap-8 fade-in">
                 <div class="flex flex-col gap-5 w-full max-w-sm">
                    <div class="text-left">
                        <label class="text-xs text-blue-300 font-bold uppercase tracking-wider mb-2 block">ID de Sala</label>
                        <div class="flex gap-2 relative">
                            <input type="text" id="remote-id-input" placeholder="Ej: ROJO-LOBO-99" class="flex-1 bg-slate-950 border border-slate-700 rounded-lg px-4 py-3 focus:outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 font-mono uppercase text-white placeholder-slate-700 transition-all text-lg pl-10 shadow-inner">
                            <div class="absolute left-3 top-4 text-slate-500">
                                <i class="ph-bold ph-hash"></i>
                            </div>
                        </div>
                    </div>
                    <button onclick="app.connectAsReceiver()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-3.5 rounded-lg font-bold transition-all shadow-lg shadow-emerald-900/20 active:scale-[0.98]">
                        Conectar ahora
                    </button>
                </div>
                <button onclick="location.reload()" class="text-slate-500 hover:text-white text-xs mt-4 underline decoration-slate-600 underline-offset-4">Volver</button>
            </div>

            <!-- 3. Emisor (Sala de espera + Dropzone) -->
            <div id="view-sender" class="hidden flex-col h-full gap-4 justify-center fade-in">
                
                <!-- Tarjeta de ID -->
                <div id="sender-id-wrapper" class="flex flex-col items-center gap-8 w-full">
                    <div class="relative w-full flex flex-col items-center">
                        <div class="absolute inset-0 bg-blue-600 blur-[80px] opacity-10"></div>
                        <div class="relative bg-slate-950/80 p-8 rounded-2xl border border-slate-700 shadow-2xl w-full max-w-xs text-center backdrop-blur-md">
                            <p class="text-[10px] text-blue-300 uppercase tracking-widest font-bold mb-4">Tu C贸digo de Sala</p>
                            <div class="flex items-center justify-center gap-3 bg-black/40 p-4 rounded-xl border border-slate-800 group cursor-pointer active:scale-95 transition-transform" onclick="app.copyId()">
                                <code id="my-peer-id" class="text-3xl font-mono text-white font-bold tracking-wider select-all">...</code>
                                <i class="ph-bold ph-copy text-slate-500 group-hover:text-white transition-colors"></i>
                            </div>
                            <div class="mt-4 flex items-center justify-center gap-2 text-[10px] text-emerald-400 bg-emerald-500/10 px-2 py-1 rounded border border-emerald-500/20">
                                <div class="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></div>
                                Se帽alizaci贸n MQTT Lista
                            </div>
                        </div>
                    </div>
                    <p class="text-slate-400 text-sm animate-pulse">Esperando conexi贸n entrante...</p>
                    <button onclick="location.reload()" class="text-slate-500 hover:text-white text-xs underline">Cancelar</button>
                </div>

                <!-- Zona de Archivos -->
                <div id="drop-zone" class="hidden flex-1 border-2 border-dashed border-slate-700 rounded-xl bg-slate-800/30 hover:bg-slate-800/50 hover:border-blue-500 transition-all flex-col items-center justify-center p-6 text-center cursor-pointer group relative overflow-hidden">
                    <input type="file" id="file-input" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="app.handleFileSelect(this)">
                    <div class="w-20 h-20 bg-slate-800 rounded-full flex items-center justify-center mb-4 group-hover:scale-110 transition-transform shadow-lg border border-slate-700">
                        <i class="ph-fill ph-file-plus text-3xl text-blue-400"></i>
                    </div>
                    <h3 class="text-xl font-bold text-white group-hover:text-blue-300 transition-colors">Selecciona un archivo</h3>
                    <p class="text-sm text-slate-400 mt-2">o arr谩stralo aqu铆</p>
                    
                    <div class="mt-8 bg-emerald-500/10 px-4 py-2 rounded-full border border-emerald-500/20 flex items-center gap-2">
                        <i class="ph-fill ph-check-circle text-emerald-400"></i>
                        <span class="text-xs text-emerald-400 font-bold uppercase tracking-wide">T煤nel P2P Establecido</span>
                    </div>
                </div>
                
                <!-- Esperando confirmaci贸n -->
                <div id="sender-waiting-approval" class="hidden flex-col items-center justify-center h-full text-center p-6 fade-in">
                    <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-6"></div>
                    <h3 class="text-lg font-bold text-white">Esperando Aceptaci贸n</h3>
                    <p class="text-slate-400 text-sm mt-2 max-w-xs">El receptor debe confirmar la descarga en su dispositivo.</p>
                </div>
            </div>

            <!-- 2b. Aceptaci贸n -->
            <div id="view-accept" class="hidden absolute inset-0 bg-slate-900/95 z-50 flex-col h-full items-center justify-center text-center gap-8 fade-in p-6 backdrop-blur-md">
                <div class="w-24 h-24 bg-slate-800 text-blue-400 rounded-2xl flex items-center justify-center shadow-2xl border border-slate-700 relative">
                    <i class="ph-fill ph-file-arrow-down text-5xl"></i>
                    <div class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 rounded-full animate-bounce"></div>
                </div>
                <div>
                    <h3 class="text-2xl font-bold text-white mb-2">Fichero Recibido</h3>
                    <p class="text-blue-300 font-medium text-lg break-all px-4" id="accept-filename">archivo.zip</p>
                    <div class="flex items-center justify-center gap-2 mt-2">
                        <span class="bg-slate-950 text-slate-400 text-xs px-3 py-1 rounded-full border border-slate-800 font-mono" id="accept-filesize">0 MB</span>
                    </div>
                </div>
                <div class="flex flex-col gap-3 w-full max-w-xs">
                    <button onclick="app.acceptTransfer()" class="w-full py-4 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-bold transition-all shadow-xl shadow-blue-900/30 active:translate-y-1">
                        Descargar Ahora
                    </button>
                    <button onclick="location.reload()" class="w-full py-3 bg-transparent border border-slate-600 hover:bg-slate-800 text-slate-400 rounded-xl transition-colors">
                        Rechazar
                    </button>
                </div>
                 <div id="ram-warning" class="hidden bg-yellow-500/10 border border-yellow-500/20 p-3 rounded-lg max-w-xs">
                    <p class="text-[10px] text-yellow-200 text-left flex gap-2">
                        <i class="ph-bold ph-warning text-lg"></i>
                        <span>
                            <strong class="block mb-1">Modo RAM (Limitado)</strong>
                            Tu navegador no soporta guardado directo. Ficheros >500MB podr铆an fallar.
                        </span>
                    </p>
                </div>
            </div>

            <!-- 4. Progreso -->
            <div id="view-progress" class="hidden flex-col h-full justify-center gap-8 fade-in">
                <div class="text-center">
                    <h3 id="file-name-display" class="font-bold text-white text-lg truncate px-4">documento.zip</h3>
                    <p id="file-size-display" class="text-xs text-slate-400 mt-1 font-mono bg-slate-950 border border-slate-800 inline-block px-2 py-1 rounded">0 MB</p>
                </div>

                <div class="space-y-2">
                    <div class="flex justify-between text-xs text-slate-300 font-bold px-1">
                        <span id="percent-display">0%</span>
                        <span id="speed-display" class="font-mono text-blue-400">0 MB/s</span>
                    </div>
                    <div class="w-full bg-slate-800 rounded-full h-3 overflow-hidden relative border border-slate-700">
                        <div id="progress-bar" class="bg-gradient-to-r from-blue-600 to-cyan-400 h-full w-0 transition-all duration-300 ease-out shadow-[0_0_15px_rgba(37,99,235,0.5)]"></div>
                    </div>
                </div>

                <div class="flex justify-center gap-2">
                    <span id="storage-mode-badge" class="text-[10px] uppercase tracking-wider px-3 py-1.5 rounded-md font-bold transition-all">...</span>
                </div>

                <p id="status-message" class="text-center text-sm text-blue-300 animate-pulse font-medium">Transfiriendo datos...</p>

                <button onclick="location.reload()" id="btn-reset" class="hidden w-full py-3.5 bg-slate-800 hover:bg-slate-700 text-white rounded-xl transition-colors font-bold flex items-center justify-center gap-2 border border-slate-600">
                    <i class="ph-bold ph-arrow-counter-clockwise"></i> Nueva Transferencia
                </button>
            </div>

        </main>

        <!-- Debug Console -->
        <div class="bg-black/90 p-3 h-32 overflow-y-auto no-scrollbar border-t border-slate-800 text-[10px] font-mono text-slate-400 select-text rounded-b-xl">
            <div id="logs" class="flex flex-col gap-1.5">
                <div class="text-slate-500 border-b border-slate-800 pb-1 mb-1 font-bold">[Sistema] Motor WebRTC v5.1 (Bulletproof) listo.</div>
            </div>
        </div>
    </div>

    <script>
        /* --- CONFIGURACIN TCNICA (STUN MASIVO) --- */
        const APP_CONFIG = {
            MQTT_BROKER: 'wss://broker.emqx.io:8084/mqtt', 
            CHUNK_SIZE: 64 * 1024,
            MAX_BUFFER: 16 * 1024 * 1024,
            RAM_LIMIT_WARNING: 500 * 1024 * 1024,
            ICE_SERVERS: [
                // Google
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                // Otros proveedores para redundancia
                { urls: 'stun:stun.ekiga.net' },
                { urls: 'stun:stun.ideasip.com' }
            ]
        };

        const ADJECTIVES = ['ROJO', 'AZUL', 'VERDE', 'NEGRO', 'BLANCO', 'RAPIDO', 'LISTO', 'FELIZ', 'BRAVO', 'NOBLE'];
        const NOUNS = ['LOBO', 'GATO', 'OSO', 'HALCON', 'ZORRO', 'LEON', 'TIGRE', 'BUHO', 'DRAGON', 'PANDA'];
        
        function generateId() {
            const adj = ADJECTIVES[Math.floor(Math.random() * ADJECTIVES.length)];
            const noun = NOUNS[Math.floor(Math.random() * NOUNS.length)];
            const num = Math.floor(Math.random() * 99) + 1;
            return `${adj}-${noun}-${num}`;
        }

        function formatBytes(bytes) {
            if (!+bytes) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return `${parseFloat((bytes / Math.pow(k, i)).toFixed(2))} ${sizes[i]}`;
        }

        /* --- MOTOR DE APLICACIN --- */
        const app = {
            mqttClient: null,
            roomId: null,
            role: null, 
            
            peerConnection: null,
            dataChannel: null,
            iceCandidateQueue: [], 
            isRemoteDescriptionSet: false, 
            isNegotiating: false, // BLOQUEO PARA EVITAR BUCLES
            
            file: null,
            fileMeta: null,
            fileChunks: [],
            receivedSize: 0,
            startTime: 0,
            fileHandle: null,
            writableStream: null,
            writeQueue: Promise.resolve(),
            supportsFileSystem: false,

            init: function() {
                this.log("Iniciando sistema...", 'system');
                this.supportsFileSystem = 'showSaveFilePicker' in window;
            },

            setRole: function(role) {
                this.role = role;
                this.hideAllViews();
                
                if (role === 'sender') {
                    this.showLoading('Conectando a Red Global', 'Obteniendo canal seguro...');
                    this.roomId = generateId();
                    this.initMQTT(this.roomId, () => {
                        this.hideAllViews();
                        this.showView('view-sender');
                        document.getElementById('my-peer-id').textContent = this.roomId;
                        this.log(`Sala creada: ${this.roomId}`, 'success');
                        this.mqttSubscribe(`lanshare/${this.roomId}/to-sender`);
                    });
                } else {
                    this.showView('view-receiver');
                    this.checkDiskSupport();
                }
            },

            checkDiskSupport: function() {
                 const msg = document.getElementById('disk-support-msg'); 
            },

            connectAsReceiver: function() {
                const inputId = document.getElementById('remote-id-input').value.trim().toUpperCase();
                if (!inputId) return alert("Introduce el c贸digo");
                
                this.roomId = inputId;
                this.showLoading('Buscando Emisor', 'Conectando al canal de se帽alizaci贸n...');
                
                this.initMQTT(this.roomId, () => {
                    this.log("MQTT Conectado. Iniciando Protocolo...", 'info');
                    this.initWebRTC(); 
                    this.mqttPublish(`lanshare/${this.roomId}/to-sender`, { type: 'hello' });
                    this.mqttSubscribe(`lanshare/${this.roomId}/to-receiver`);
                });
            },

            /* --- MQTT (SIGNALING) --- */
            initMQTT: function(topicBase, onConnected) {
                const clientId = 'lan_' + Math.random().toString(16).substr(2, 8);
                this.mqttClient = mqtt.connect(APP_CONFIG.MQTT_BROKER, {
                    clientId: clientId,
                    keepalive: 60, clean: true, reconnectPeriod: 1000, connectTimeout: 10000
                });

                this.mqttClient.on('connect', () => {
                    this.log("Broker MQTT conectado.", 'system');
                    if (onConnected) onConnected();
                });

                this.mqttClient.on('message', (topic, message) => {
                    try {
                        const data = JSON.parse(message.toString());
                        this.handleSignalingData(data);
                    } catch (e) { console.error(e); }
                });

                this.mqttClient.on('error', (err) => {
                    this.log(`Error MQTT: ${err.message}`, 'error');
                });
            },

            mqttSubscribe: function(topic) {
                this.mqttClient.subscribe(topic, (err) => {
                    if(!err) this.log(`Escuchando en: ${topic}`, 'system');
                });
            },

            mqttPublish: function(topic, data) {
                if (this.mqttClient && this.mqttClient.connected) {
                    this.mqttClient.publish(topic, JSON.stringify(data));
                }
            },

            /* --- WEBRTC (CORE) --- */
            initWebRTC: function() {
                if(this.peerConnection) return; // EVITAR REINICIOS

                this.log("Inicializando RTCPeerConnection...", 'info');
                this.iceCandidateQueue = []; 
                this.isRemoteDescriptionSet = false;
                this.isNegotiating = false;
                
                this.peerConnection = new RTCPeerConnection({
                    iceServers: APP_CONFIG.ICE_SERVERS,
                    iceTransportPolicy: 'all',
                    sdpSemantics: 'unified-plan'
                });

                this.peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        // Diagn贸stico de IPs
                        const ip = event.candidate.address || event.candidate.ip || 'an贸nima';
                        const type = event.candidate.type; 
                        this.log(`Candidato encontrado: ${type} (${ip})`, 'system'); // Log clave

                        const target = this.role === 'sender' ? 'to-receiver' : 'to-sender';
                        this.mqttPublish(`lanshare/${this.roomId}/${target}`, {
                            type: 'candidate',
                            candidate: event.candidate.toJSON() // Serializaci贸n segura
                        });
                    }
                };

                this.peerConnection.onconnectionstatechange = () => {
                    const state = this.peerConnection.connectionState;
                    this.log(`Estado WebRTC: ${state}`, state === 'connected' ? 'success' : 'info');
                    
                    if(state === 'connected') {
                        this.onWebRTCConnected();
                    } else if (state === 'failed') {
                        this.log("Fallo WebRTC. Revisa si hay candidatos HOST o SRFLX.", 'error');
                        // Opcional: restartIce()
                    }
                };

                if (this.role === 'sender') {
                    this.dataChannel = this.peerConnection.createDataChannel("file-transfer");
                    this.setupDataChannel();
                } else {
                    this.peerConnection.ondatachannel = (event) => {
                        this.dataChannel = event.channel;
                        this.setupDataChannel();
                    };
                }
            },

            setupDataChannel: function() {
                this.dataChannel.onopen = () => {
                    this.log("隆CANAL P2P ABIERTO!", 'success');
                    this.hideAllViews();
                    this.showConnectedUI();
                };
                this.dataChannel.onmessage = (event) => this.handleP2PData(event.data);
                this.dataChannel.onerror = (error) => this.log(`Error Canal: ${error}`, 'error');
            },

            onWebRTCConnected: function() {
                document.getElementById('connection-status').classList.remove('hidden');
                document.getElementById('connection-status').classList.add('flex');
            },

            /* --- NEGOCIACIN --- */
            handleSignalingData: async function(data) {
                try {
                    if (data.type === 'hello' && this.role === 'sender') {
                        if(this.isNegotiating) return; // Evitar loops
                        this.isNegotiating = true;

                        this.log("Receptor listo. Iniciando oferta...", 'info');
                        this.initWebRTC(); 
                        const offer = await this.peerConnection.createOffer();
                        await this.peerConnection.setLocalDescription(offer);
                        this.mqttPublish(`lanshare/${this.roomId}/to-receiver`, { type: 'offer', offer: offer });

                    } else if (data.type === 'offer' && this.role === 'receiver') {
                        this.log("Oferta recibida. Configurando remoto...", 'info');
                        this.initWebRTC(); // Asegurar init en receptor
                        
                        await this.peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
                        this.isRemoteDescriptionSet = true;
                        await this.processIceQueue();
                        
                        const answer = await this.peerConnection.createAnswer();
                        await this.peerConnection.setLocalDescription(answer);
                        this.mqttPublish(`lanshare/${this.roomId}/to-sender`, { type: 'answer', answer: answer });

                    } else if (data.type === 'answer' && this.role === 'sender') {
                        this.log("Respuesta recibida. Finalizando handshake...", 'info');
                        
                        await this.peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
                        this.isRemoteDescriptionSet = true;
                        await this.processIceQueue();

                    } else if (data.type === 'candidate') {
                        // Construir objeto Candidato expl铆cito
                        const candidate = new RTCIceCandidate(data.candidate);
                        
                        if (this.isRemoteDescriptionSet) {
                            await this.peerConnection.addIceCandidate(candidate);
                        } else {
                            this.iceCandidateQueue.push(candidate);
                        }
                    }
                } catch (e) {
                    this.log(`Error Se帽alizaci贸n: ${e.message}`, 'error');
                    console.error(e);
                }
            },

            processIceQueue: async function() {
                while(this.iceCandidateQueue.length > 0) {
                    const candidate = this.iceCandidateQueue.shift();
                    try {
                        await this.peerConnection.addIceCandidate(candidate);
                    } catch (e) { console.error(e); }
                }
            },

            /* --- TRANSFERENCIA DE ARCHIVOS --- */
            sendP2P: function(msg) {
                if (this.dataChannel && this.dataChannel.readyState === 'open') {
                    if (typeof msg === 'object' && !(msg instanceof ArrayBuffer)) {
                        this.dataChannel.send(JSON.stringify(msg));
                    } else {
                        this.dataChannel.send(msg); 
                    }
                }
            },

            handleP2PData: async function(raw) {
                if (raw instanceof ArrayBuffer) {
                    this.processChunk(raw);
                    return;
                }
                try {
                    const data = JSON.parse(raw);
                    if (data.type === 'meta') {
                        this.fileMeta = data;
                        this.log(`Fichero: ${data.name} (${formatBytes(data.size)})`, 'info');
                        document.getElementById('accept-filename').textContent = data.name;
                        document.getElementById('accept-filesize').textContent = formatBytes(data.size);
                        this.showView('view-accept');
                        if(!this.supportsFileSystem && data.size > APP_CONFIG.RAM_LIMIT_WARNING) {
                            document.getElementById('ram-warning').classList.remove('hidden');
                        }
                    } else if (data.type === 'ack') {
                        this.log("Iniciando transmisi贸n de datos...", 'success');
                        document.getElementById('sender-waiting-approval').classList.add('hidden');
                        this.showView('view-progress');
                        this.startSending();
                    } else if (data.type === 'end') {
                        this.finishReception();
                    }
                } catch (e) { }
            },

            handleFileSelect: function(input) {
                const file = input.files[0];
                if (!file) return;
                this.file = file;
                this.sendP2P({ type: 'meta', name: file.name, size: file.size, mime: file.type });
                
                document.getElementById('drop-zone').classList.add('hidden');
                document.getElementById('drop-zone').classList.remove('flex');
                document.getElementById('sender-waiting-approval').classList.remove('hidden');
                document.getElementById('sender-waiting-approval').classList.add('flex');
                this.log(`Esperando aceptaci贸n...`, 'info');
            },

            acceptTransfer: async function() {
                this.receivedSize = 0;
                this.fileChunks = [];
                this.writeQueue = Promise.resolve();

                if (this.supportsFileSystem) {
                    try {
                        this.fileHandle = await window.showSaveFilePicker({ suggestedName: this.fileMeta.name });
                        this.writableStream = await this.fileHandle.createWritable();
                        this.setStorageBadge(true);
                    } catch (err) {
                        this.supportsFileSystem = false;
                        this.setStorageBadge(false);
                    }
                } else { this.setStorageBadge(false); }

                this.showView('view-progress');
                this.updateUIProgress(0, this.fileMeta.size);
                document.getElementById('status-message').textContent = "Recibiendo...";
                this.startTime = Date.now();
                this.sendP2P({ type: 'ack' });
            },

            startSending: function() {
                const file = this.file;
                let offset = 0;
                this.startTime = Date.now();
                const reader = new FileReader();

                const readNextChunk = () => {
                    const slice = file.slice(offset, offset + APP_CONFIG.CHUNK_SIZE);
                    reader.readAsArrayBuffer(slice);
                };

                reader.onload = (e) => {
                    if (this.dataChannel.readyState !== 'open') return;
                    this.dataChannel.send(e.target.result); 
                    offset += e.target.result.byteLength;
                    this.updateUIProgress(offset, file.size);
                    if (this.dataChannel.bufferedAmount > APP_CONFIG.MAX_BUFFER) {
                        setTimeout(readNextChunk, 50);
                    } else if (offset < file.size) {
                        setTimeout(readNextChunk, 0);
                    } else {
                        this.sendP2P({ type: 'end' });
                        this.finishTransfer(true);
                    }
                };
                readNextChunk();
            },

            processChunk: function(buffer) {
                this.receivedSize += buffer.byteLength;
                this.updateUIProgress(this.receivedSize, this.fileMeta.size);

                if (this.supportsFileSystem && this.writableStream) {
                    this.writeQueue = this.writeQueue.then(() => 
                        this.writableStream.write(buffer)
                    ).catch(err => console.error(err));
                } else {
                    this.fileChunks.push(buffer);
                }
            },

            finishReception: async function() {
                if (this.supportsFileSystem && this.writableStream) {
                    await this.writeQueue;
                    await this.writableStream.close();
                } else {
                    const blob = new Blob(this.fileChunks, { type: this.fileMeta.mime });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = this.fileMeta.name;
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(() => URL.revokeObjectURL(url), 5000);
                    this.fileChunks = [];
                }
                this.finishTransfer(false);
            },

            /* --- UI UTILS --- */
            showConnectedUI: function() {
                if(this.role === 'receiver') {
                    this.showLoading('Conectado', 'Esperando fichero del emisor...');
                } else {
                    document.getElementById('sender-id-wrapper').classList.add('hidden');
                    document.getElementById('drop-zone').classList.remove('hidden');
                    document.getElementById('drop-zone').classList.add('flex');
                }
            },

            updateUIProgress: function(current, total) {
                const percent = Math.round((current / total) * 100);
                document.getElementById('percent-display').textContent = percent + '%';
                document.getElementById('progress-bar').style.width = percent + '%';
                
                if(this.file || this.fileMeta) {
                     const name = this.file ? this.file.name : this.fileMeta.name;
                     const totalSize = this.file ? this.file.size : this.fileMeta.size;
                     document.getElementById('file-name-display').textContent = name;
                     const sizeEl = document.getElementById('file-size-display');
                     if(sizeEl.textContent === '0 MB') sizeEl.textContent = formatBytes(totalSize);
                }

                const now = Date.now();
                const duration = (now - this.startTime) / 1000;
                if (duration > 1) {
                    const speed = (current / 1024 / 1024) / duration;
                    document.getElementById('speed-display').textContent = speed.toFixed(1) + ' MB/s';
                }
            },

            finishTransfer: function(isSender) {
                document.getElementById('status-message').textContent = isSender ? "Env铆o completado" : "Recibido correctamente";
                document.getElementById('status-message').className = "text-center text-sm text-emerald-400 font-bold";
                document.getElementById('progress-bar').className = "bg-emerald-500 h-full w-full";
                document.getElementById('btn-reset').classList.remove('hidden');
            },

            showLoading: function(title, text) {
                document.getElementById('view-loading').classList.remove('hidden');
                document.getElementById('view-loading').classList.add('flex');
                document.getElementById('loading-title').textContent = title;
                document.getElementById('loading-status').textContent = text;
            },

            hideAllViews: function() {
                const views = ['view-home', 'view-receiver', 'view-sender', 'view-loading', 'view-progress', 'view-accept'];
                views.forEach(v => {
                    const el = document.getElementById(v);
                    el.classList.add('hidden');
                    el.classList.remove('flex');
                });
            },

            showView: function(id) {
                this.hideAllViews();
                document.getElementById(id).classList.remove('hidden');
                document.getElementById(id).classList.add('flex');
            },

            setStorageBadge: function(isDisk) {
                const badge = document.getElementById('storage-mode-badge');
                if(isDisk) {
                    badge.innerHTML = " DISCO";
                    badge.className = "text-[10px] uppercase font-bold tracking-widest px-3 py-1 bg-emerald-500/20 text-emerald-400 border border-emerald-500/30 rounded";
                } else {
                    badge.innerHTML = " RAM";
                    badge.className = "text-[10px] uppercase font-bold tracking-widest px-3 py-1 bg-yellow-500/20 text-yellow-400 border border-yellow-500/30 rounded";
                }
            },

            log: function(msg, type='info') {
                const logs = document.getElementById('logs');
                const div = document.createElement('div');
                div.className = "mb-1 border-b border-slate-800/50 pb-0.5";
                const time = new Date().toLocaleTimeString();
                let color = "text-slate-400";
                if(type==='error') color="text-red-400 font-bold";
                if(type==='success') color="text-emerald-400";
                if(type==='system') color="text-blue-400";
                
                div.innerHTML = `<span class="opacity-50 text-[10px]">[${time}]</span> <span class="${color}">${msg}</span>`;
                logs.appendChild(div);
                logs.scrollTop = logs.scrollHeight;
            },

            copyId: function() {
                navigator.clipboard.writeText(this.roomId).then(() => alert("C贸digo copiado"));
            }
        };

        window.addEventListener('dragover', e => e.preventDefault());
        window.addEventListener('drop', e => e.preventDefault());
        
        app.init();
    </script>
</body>
</html>