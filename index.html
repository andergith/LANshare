<!DOCTYPE html>
<html lang="es-ES">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAN Drop - Streaming a Disco</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PeerJS -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <!-- Iconos Phosphor -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .animate-pulse-slow {
            animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 min-h-screen text-slate-100 flex items-center justify-center p-4">

    <div class="w-full max-w-lg bg-slate-800/80 border border-slate-700 rounded-2xl shadow-2xl overflow-hidden relative min-h-[550px] flex flex-col">
        
        <!-- Header -->
        <div class="p-6 border-b border-slate-700 flex justify-between items-center bg-slate-800/90 sticky top-0 z-10">
            <div class="flex items-center gap-2">
                <i class="ph-fill ph-paper-plane-tilt text-blue-400 text-2xl"></i>
                <h1 class="text-xl font-bold tracking-tight">LAN Drop</h1>
            </div>
            <div id="connection-status" class="hidden text-xs font-mono bg-emerald-500/20 text-emerald-400 px-2 py-1 rounded-full flex items-center gap-1">
                <div class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></div>
                Conectado
            </div>
        </div>

        <!-- VISTAS DE LA APP -->
        <main class="flex-1 relative p-6">
            
            <!-- 1. Inicio -->
            <div id="view-home" class="flex flex-col gap-6 h-full justify-center fade-in">
                <p class="text-slate-400 text-center text-sm">Elige tu rol para comenzar la transferencia.</p>
                
                <button onclick="app.setRole('sender')" class="group relative p-6 rounded-xl bg-slate-700/50 hover:bg-blue-600/20 border border-slate-600 hover:border-blue-500 transition-all duration-300 text-left">
                    <div class="absolute top-4 right-4 bg-blue-500/20 p-2 rounded-lg group-hover:bg-blue-500 group-hover:text-white transition-colors text-blue-400">
                        <i class="ph ph-upload-simple text-xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-white mb-1">Enviar Ficheros</h3>
                    <p class="text-slate-400 text-xs">Sube archivos a la red local.</p>
                </button>

                <button onclick="app.setRole('receiver')" class="group relative p-6 rounded-xl bg-slate-700/50 hover:bg-emerald-600/20 border border-slate-600 hover:border-emerald-500 transition-all duration-300 text-left">
                    <div class="absolute top-4 right-4 bg-emerald-500/20 p-2 rounded-lg group-hover:bg-emerald-500 group-hover:text-white transition-colors text-emerald-400">
                        <i class="ph ph-download-simple text-xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-white mb-1">Recibir Ficheros</h3>
                    <p class="text-slate-400 text-xs">Descarga directa a disco (si es compatible).</p>
                </button>
            </div>

            <!-- 2. Receptor (Esperando) -->
            <div id="view-receiver" class="hidden flex-col h-full items-center justify-center text-center gap-6">
                <div class="relative">
                    <div class="absolute inset-0 bg-emerald-500 blur-xl opacity-20 animate-pulse-slow"></div>
                    <div class="relative bg-slate-900 p-4 rounded-xl border border-slate-700 shadow-xl">
                        <p class="text-xs text-slate-400 uppercase tracking-widest mb-2">Tu ID de Receptor</p>
                        <div class="flex items-center gap-2 bg-black/30 p-3 rounded-lg border border-slate-700/50">
                            <code id="my-peer-id" class="text-2xl font-mono text-emerald-400 font-bold tracking-wider">...</code>
                            <button onclick="app.copyId()" class="p-2 hover:bg-white/10 rounded transition-colors text-slate-400 hover:text-white" title="Copiar">
                                <i class="ph ph-copy"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <p class="text-slate-400 text-sm max-w-xs mx-auto">
                    Comparte este ID con el emisor. <br>
                    <span class="text-emerald-400 text-xs mt-2 block opacity-80" id="disk-support-msg">Verificando soporte de disco...</span>
                </p>
                <button onclick="location.reload()" class="text-slate-500 hover:text-white text-xs mt-4 underline">Cancelar</button>
            </div>

            <!-- 2b. Receptor (Aceptaci√≥n de archivo) -->
            <div id="view-accept" class="hidden flex-col h-full items-center justify-center text-center gap-6 fade-in">
                <div class="w-20 h-20 bg-blue-500/20 text-blue-400 rounded-full flex items-center justify-center animate-bounce">
                    <i class="ph-fill ph-file-arrow-down text-4xl"></i>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-white mb-1">Solicitud de Archivo</h3>
                    <p class="text-slate-400 text-sm" id="accept-filename">archivo.zip</p>
                    <p class="text-slate-500 text-xs mt-1" id="accept-filesize">100 MB</p>
                </div>
                
                <div class="flex flex-col gap-3 w-full max-w-xs">
                    <button onclick="app.acceptTransfer()" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-medium transition-colors flex items-center justify-center gap-2">
                        <i class="ph-bold ph-floppy-disk"></i> Guardar y Recibir
                    </button>
                    <button onclick="location.reload()" class="w-full py-3 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded-lg transition-colors">
                        Rechazar
                    </button>
                </div>
                <p class="text-[10px] text-slate-500 max-w-xs">
                    Si tu navegador es compatible, te pediremos d√≥nde guardar el archivo ahora para escribir directamente en el disco.
                </p>
            </div>

            <!-- 3. Emisor -->
            <div id="view-sender" class="hidden flex-col h-full gap-4">
                <div id="connect-form" class="flex flex-col gap-4">
                    <label class="text-sm text-slate-300 font-medium">Introduce el ID del receptor:</label>
                    <div class="flex gap-2">
                        <input type="text" id="remote-id-input" placeholder="Ej: azul-gato-99" class="flex-1 bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500 font-mono uppercase text-white placeholder-slate-600">
                        <button onclick="app.connectToPeer()" class="bg-blue-600 hover:bg-blue-500 text-white px-6 rounded-lg font-medium transition-colors disabled:opacity-50" id="btn-connect">
                            Conectar
                        </button>
                    </div>
                </div>

                <div id="drop-zone" class="hidden flex-1 border-2 border-dashed border-slate-600 rounded-xl bg-slate-800/30 hover:bg-slate-800/50 transition-all flex-col items-center justify-center p-6 text-center cursor-pointer group relative">
                    <input type="file" id="file-input" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="app.handleFileSelect(this)">
                    <div class="w-16 h-16 bg-slate-700 rounded-full flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                        <i class="ph-fill ph-file-plus text-3xl text-blue-400"></i>
                    </div>
                    <h3 class="text-lg font-medium text-white">Elige un archivo</h3>
                    <p class="text-sm text-slate-400 mt-1">o arr√°stralo aqu√≠</p>
                </div>
                
                <!-- Estado de espera para el emisor -->
                <div id="sender-waiting-approval" class="hidden text-center p-4 bg-slate-800/50 rounded-lg border border-slate-700 animate-pulse">
                    <p class="text-sm text-yellow-400">Esperando que el receptor acepte y guarde...</p>
                </div>
            </div>

            <!-- 4. Progreso -->
            <div id="view-progress" class="hidden flex-col h-full justify-center gap-6">
                <div class="text-center">
                    <div class="w-16 h-16 bg-blue-500/20 text-blue-400 rounded-2xl mx-auto flex items-center justify-center mb-4">
                        <i class="ph-fill ph-file text-3xl"></i>
                    </div>
                    <h3 id="file-name-display" class="font-medium text-white truncate px-4">documento.zip</h3>
                    <p id="file-size-display" class="text-xs text-slate-400 mt-1">0 MB</p>
                </div>

                <div class="w-full bg-slate-700 rounded-full h-4 overflow-hidden relative">
                    <div id="progress-bar" class="bg-gradient-to-r from-blue-500 to-cyan-400 h-full w-0 transition-all duration-200"></div>
                </div>

                <div class="flex justify-between text-xs text-slate-400 font-mono px-1">
                    <span id="speed-display">0 MB/s</span>
                    <span id="percent-display">0%</span>
                </div>

                <div class="flex justify-center gap-2">
                    <span id="storage-mode-badge" class="text-[10px] uppercase tracking-wider px-2 py-1 rounded bg-slate-700 text-slate-400">Modo Memoria</span>
                </div>

                <p id="status-message" class="text-center text-sm text-blue-300 animate-pulse">Transfiriendo...</p>

                <button onclick="location.reload()" id="btn-reset" class="hidden w-full py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors mt-4">
                    Nueva Transferencia
                </button>
            </div>

        </main>

        <!-- Logs -->
        <div class="bg-black/40 p-2 h-24 overflow-y-auto no-scrollbar border-t border-slate-700/50 text-[10px] font-mono text-slate-500">
            <div id="logs" class="flex flex-col gap-1 px-2">
                <div>[Sistema] Listo. Esperando usuario...</div>
            </div>
        </div>
    </div>

    <script>
        const ADJECTIVES = ['rojo', 'azul', 'verde', 'negro', 'blanco', 'rapido', 'listo', 'feliz', 'bravo', 'noble'];
        const NOUNS = ['lobo', 'gato', 'oso', 'halcon', 'zorro', 'leon', 'tigre', 'buho', 'dragon', 'panda'];
        
        function generateFriendlyId() {
            const adj = ADJECTIVES[Math.floor(Math.random() * ADJECTIVES.length)];
            const noun = NOUNS[Math.floor(Math.random() * NOUNS.length)];
            const num = Math.floor(Math.random() * 99) + 1;
            return `${adj}-${noun}-${num}`;
        }

        function formatBytes(bytes, decimals = 2) {
            if (!+bytes) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
        }

        const app = {
            peer: null,
            conn: null,
            myId: null,
            role: null,
            file: null,
            // Variables de transferencia
            chunkSize: 16 * 1024,
            fileChunks: [], // Fallback RAM
            receivedSize: 0,
            fileMeta: null,
            startTime: 0,
            
            // Streaming directo a disco
            fileHandle: null,
            writableStream: null,
            writeQueue: Promise.resolve(), // Cola para serializar escrituras
            supportsFileSystem: false,

            init: function() {
                this.log("Iniciando aplicaci√≥n...");
                // Verificar soporte de File System Access API
                this.supportsFileSystem = 'showSaveFilePicker' in window;
            },

            setRole: function(role) {
                this.role = role;
                this.hideAllViews();
                this.myId = generateFriendlyId();
                this.peer = new Peer(this.myId);

                this.peer.on('open', (id) => {
                    this.log(`Peer conectado: ${id}`);
                    if (role === 'receiver') {
                        this.showView('view-receiver');
                        document.getElementById('my-peer-id').textContent = id;
                        
                        const msg = document.getElementById('disk-support-msg');
                        if (this.supportsFileSystem) {
                            msg.textContent = "‚úÖ Soporte Disco Directo Activado";
                            msg.className = "text-emerald-400 text-xs mt-2 block opacity-80 font-bold";
                        } else {
                            msg.textContent = "‚ö†Ô∏è Sin soporte de disco directo (Usando RAM)";
                            msg.className = "text-yellow-500 text-xs mt-2 block opacity-80";
                        }
                        this.initReceiver();
                    } else {
                        this.showView('view-sender');
                    }
                });

                this.peer.on('error', (err) => {
                    this.log(`Error PeerJS: ${err.type}`, 'error');
                    alert(`Error: ${err.type}`);
                });
            },

            // --- RECEPTOR ---
            initReceiver: function() {
                this.peer.on('connection', (conn) => {
                    this.conn = conn;
                    this.setupConnectionEvents();
                });
            },

            // --- EMISOR ---
            connectToPeer: function() {
                const remoteId = document.getElementById('remote-id-input').value.trim().toLowerCase();
                if (!remoteId) return alert('Introduce ID');

                const btn = document.getElementById('btn-connect');
                btn.disabled = true;
                btn.textContent = '...';

                this.conn = this.peer.connect(remoteId);
                this.conn.on('open', () => {
                    this.log("Conectado con " + remoteId);
                    this.setupConnectionEvents();
                    document.getElementById('connect-form').classList.add('hidden');
                    document.getElementById('drop-zone').classList.remove('hidden');
                    document.getElementById('drop-zone').classList.add('flex');
                    this.showConnectedStatus();
                });
            },

            setupConnectionEvents: function() {
                this.showConnectedStatus();
                this.conn.on('data', (data) => this.handleData(data));
                this.conn.on('close', () => {
                    alert("Conexi√≥n perdida.");
                    location.reload();
                });
            },

            // --- GESTI√ìN DE DATOS (M√ÅQUINA DE ESTADOS) ---
            handleData: async function(data) {
                if (data.type === 'meta') {
                    // Paso 1: Llega oferta de archivo
                    this.fileMeta = data;
                    this.showView('view-accept');
                    document.getElementById('accept-filename').textContent = data.name;
                    document.getElementById('accept-filesize').textContent = formatBytes(data.size);
                    this.log(`Oferta recibida: ${data.name}`);

                } else if (data.type === 'ready-ack') {
                    // Paso 3 (Emisor): El receptor acept√≥, empezamos a enviar
                    this.log("Receptor listo. Iniciando env√≠o...");
                    document.getElementById('sender-waiting-approval').classList.add('hidden');
                    this.showView('view-progress');
                    this.sendChunks();

                } else if (data.type === 'chunk') {
                    // Paso 4 (Receptor): Recibiendo datos
                    this.processChunk(data.data);

                } else if (data.type === 'end') {
                    // Paso 5: Fin
                    this.finishReception();
                }
            },

            // --- INTERACCI√ìN RECEPTOR: ACEPTAR ---
            acceptTransfer: async function() {
                this.receivedSize = 0;
                this.fileChunks = [];
                this.writeQueue = Promise.resolve();

                // Intentar usar File System Access API
                if (this.supportsFileSystem) {
                    try {
                        // Pedir al usuario d√≥nde guardar
                        this.fileHandle = await window.showSaveFilePicker({
                            suggestedName: this.fileMeta.name
                        });
                        this.writableStream = await this.fileHandle.createWritable();
                        this.log("Stream a disco iniciado.");
                        this.setStorageBadge(true);
                    } catch (err) {
                        console.error(err);
                        this.log("Usuario cancel√≥ o error en FS. Usando RAM.", 'error');
                        // Fallback a RAM si cancela o falla, pero seguimos adelante
                        this.supportsFileSystem = false; 
                        this.setStorageBadge(false);
                    }
                } else {
                    this.setStorageBadge(false);
                }

                // Configurar UI
                this.showView('view-progress');
                document.getElementById('file-name-display').textContent = this.fileMeta.name;
                document.getElementById('file-size-display').textContent = formatBytes(this.fileMeta.size);
                document.getElementById('status-message').textContent = "Recibiendo...";
                this.startTime = Date.now();

                // Avisar al Emisor que estamos listos
                this.conn.send({ type: 'ready-ack' });
            },

            // --- PROCESAMIENTO DE CHUNKS ---
            processChunk: function(chunkData) {
                this.receivedSize += chunkData.byteLength;
                this.updateProgress(this.receivedSize, this.fileMeta.size);

                if (this.supportsFileSystem && this.writableStream) {
                    // Escribir a disco (encolado para evitar race conditions)
                    this.writeQueue = this.writeQueue.then(() => 
                        this.writableStream.write(chunkData)
                    ).catch(err => {
                        this.log("Error escritura disco: " + err, 'error');
                        // En caso catastr√≥fico de disco, podr√≠amos intentar fallback a RAM, 
                        // pero con archivos grandes ya habr√≠amos perdido el inicio.
                    });
                } else {
                    // Guardar en RAM
                    this.fileChunks.push(chunkData);
                }
            },

            finishReception: async function() {
                if (this.supportsFileSystem && this.writableStream) {
                    await this.writeQueue; // Esperar √∫ltimas escrituras
                    await this.writableStream.close();
                    this.log("Archivo guardado en disco correctamente.");
                } else {
                    // Reensamblar RAM
                    this.log("Reensamblando en RAM...");
                    const blob = new Blob(this.fileChunks, { type: this.fileMeta.mime });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = this.fileMeta.name;
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(() => {
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                        this.fileChunks = [];
                    }, 1000);
                }
                this.finishTransfer(false);
            },

            // --- EMISOR: ENV√çO ---
            handleFileSelect: function(input) {
                const file = input.files[0];
                if (!file) return;
                this.file = file;
                
                // Enviar solo META primero
                this.conn.send({
                    type: 'meta',
                    name: this.file.name,
                    size: this.file.size,
                    mime: this.file.type
                });

                // Mostrar estado "Esperando"
                document.getElementById('drop-zone').classList.add('hidden');
                document.getElementById('drop-zone').classList.remove('flex');
                document.getElementById('sender-waiting-approval').classList.remove('hidden');
                this.log(`Esperando aceptaci√≥n de ${this.file.name}...`);
            },

            sendChunks: function() {
                // Configurar UI Emisor
                document.getElementById('file-name-display').textContent = this.file.name;
                document.getElementById('file-size-display').textContent = formatBytes(this.file.size);
                
                const file = this.file;
                let offset = 0;
                this.startTime = Date.now();
                const reader = new FileReader();

                const readNextChunk = () => {
                    const slice = file.slice(offset, offset + this.chunkSize);
                    reader.readAsArrayBuffer(slice);
                };

                reader.onload = (e) => {
                    if (!this.conn || !this.conn.open) return;
                    
                    this.conn.send({ type: 'chunk', data: e.target.result });
                    offset += e.target.result.byteLength;
                    this.updateProgress(offset, file.size);

                    if (this.conn.dataChannel.bufferedAmount > 16 * 1024 * 1024) {
                         setTimeout(readNextChunk, 50);
                    } else if (offset < file.size) {
                        setTimeout(readNextChunk, 0); 
                    } else {
                        this.conn.send({ type: 'end' });
                        this.finishTransfer(true);
                    }
                };
                readNextChunk();
            },

            // --- UI HELPER ---
            updateProgress: function(current, total) {
                const percent = Math.min(100, Math.round((current / total) * 100));
                document.getElementById('progress-bar').style.width = `${percent}%`;
                document.getElementById('percent-display').textContent = `${percent}%`;
                
                const now = Date.now();
                const duration = (now - this.startTime) / 1000;
                if (duration > 0) {
                    const speed = (current / 1024 / 1024) / duration;
                    document.getElementById('speed-display').textContent = `${speed.toFixed(2)} MB/s`;
                }
            },

            finishTransfer: function(isSender) {
                document.getElementById('progress-bar').classList.remove('from-blue-500', 'to-cyan-400');
                document.getElementById('progress-bar').classList.add('bg-emerald-500');
                document.getElementById('status-message').textContent = isSender ? "Enviado" : "Guardado";
                document.getElementById('status-message').classList.remove('animate-pulse', 'text-blue-300');
                document.getElementById('status-message').classList.add('text-emerald-400', 'font-bold');
                document.getElementById('btn-reset').classList.remove('hidden');
            },

            hideAllViews: function() {
                ['view-home', 'view-receiver', 'view-accept', 'view-sender', 'view-progress'].forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                    document.getElementById(id).classList.remove('flex');
                });
            },

            showView: function(id) {
                this.hideAllViews();
                document.getElementById(id).classList.remove('hidden');
                document.getElementById(id).classList.add('flex');
            },

            showConnectedStatus: function() {
                document.getElementById('connection-status').classList.remove('hidden');
                document.getElementById('connection-status').classList.add('flex');
            },

            setStorageBadge: function(isDisk) {
                const badge = document.getElementById('storage-mode-badge');
                if (isDisk) {
                    badge.textContent = "üíæ MODO DISCO";
                    badge.className = "text-[10px] uppercase tracking-wider px-2 py-1 rounded bg-emerald-500/20 text-emerald-400 font-bold border border-emerald-500/30";
                } else {
                    badge.textContent = "üß† MODO RAM";
                    badge.className = "text-[10px] uppercase tracking-wider px-2 py-1 rounded bg-yellow-500/20 text-yellow-400 font-bold border border-yellow-500/30";
                }
            },

            log: function(msg, type = 'info') {
                const logDiv = document.getElementById('logs');
                const entry = document.createElement('div');
                const time = new Date().toLocaleTimeString();
                entry.textContent = `[${time}] ${msg}`;
                if (type === 'error') entry.style.color = '#ef4444';
                logDiv.appendChild(entry);
                logDiv.scrollTop = logDiv.scrollHeight;
            },

            copyId: function() {
                navigator.clipboard.writeText(this.myId).then(() => alert("ID copiado"));
            }
        };

        window.addEventListener('dragover', e => e.preventDefault());
        window.addEventListener('drop', e => e.preventDefault());
        app.init();
    </script>
</body>
</html>